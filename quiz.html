<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Quiz</title>
  <link rel="stylesheet" href="./assets/app.css"/>

  <style>
    :root { --card:#141a19; --line:#26302d; --ink:#e7f4f0; --sub:#9db5ae; --chip:#23302c; }
    body{color:var(--ink)}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header.space-between{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .btn{display:inline-block;padding:.6rem .9rem;border-radius:.6rem;background:#24312d;color:var(--ink);text-decoration:none}
    .btn.primary{background:#2e7cf0;color:#fff;font-weight:600}
    .btn.muted{background:#1b2422;color:#cfe8df}
    .card{background:#121917;border:1px solid var(--line);border-radius:14px;padding:16px 18px;margin:14px 0}
    .muted{color:var(--sub)}
    .question{font-size:1.05rem;margin:8px 0 10px}
    .option{display:block;margin:8px 0;padding:8px 10px;border:1px solid #2a3632;border-radius:10px;cursor:pointer}
    .option input{margin-right:10px}
    .stack{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="space-between">
      <h1>Quiz</h1>
      <a class="btn muted" href="./index.html">← Home</a>
    </header>

    <section class="card" id="quizCard">
      <div id="quizMsg" class="muted">Loading…</div>

      <div id="quizBody" style="display:none">
        <div id="meta" class="muted" style="margin-bottom:6px"></div>
        <div id="qnum" class="muted" style="margin-bottom:8px"></div>
        <div id="qstem" class="question"></div>
        <div id="opts"></div>

        <div class="stack" style="margin-top:14px">
          <button id="backBtn"   class="btn muted">← Back</button>
          <button id="nextBtn"   class="btn muted">Next →</button>
          <button id="submitBtn" class="btn primary">Submit</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Core scripts (as in index.html) -->
  <script src="./assets/firebase.js"></script>
  <script src="./assets/app.js"></script>

  <script>
  (function(){
    const log = (...a)=>console.log("%c[QUIZ]", "color:#6cf", ...a);
    const warn = (...a)=>console.warn("[QUIZ]", ...a);
    const err = (...a)=>console.error("[QUIZ]", ...a);

    // ---------------- Params ----------------
    const params = new URLSearchParams(location.search);
    const level   = (params.get("level")   || "").toLowerCase();
    const subject = (params.get("subject") || "").toLowerCase();
    const dataUrl = `./data/${level}_${subject}.json`;

    // ---------------- DOM ----------------
    const msgEl   = document.getElementById("quizMsg");
    const cardEl  = document.getElementById("quizCard");
    const bodyEl  = document.getElementById("quizBody");
    const metaEl  = document.getElementById("meta");
    const qnumEl  = document.getElementById("qnum");
    const stemEl  = document.getElementById("qstem");
    const optsEl  = document.getElementById("opts");
    const backBtn = document.getElementById("backBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");

    // ---------------- State ----------------
    let items = [];
    let idx = 0;
    const answers = new Map(); // qid -> choice index

    // ---------------- Utils ----------------
    const shuffleInPlace = (arr)=>{
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    };

    const dedupeById = (arr)=>{
      const seen = new Set();
      const out = [];
      for(const q of arr){
        const id = q.id || q.qid || q.question_id || JSON.stringify(q).slice(0,60);
        if(!seen.has(id)){
          seen.add(id);
          // normalize id field
          out.push(Object.assign({id}, q));
        }
      }
      return out;
    };

    // shuffle options while tracking correct index
    const withShuffledOptions = (q)=>{
      const indices = q.options.map((_,i)=>i);
      shuffleInPlace(indices);
      const newOptions = indices.map(i=>q.options[i]);
      const newAnswerIndex = indices.indexOf(q.answer_index);
      return Object.assign({}, q, { options:newOptions, answer_index:newAnswerIndex });
    };

    // ---------------- Auth (optional) ----------------
    function waitAuthIfAvailable(){
      return new Promise((resolve)=>{
        const onAuthChanged = window.AppOnAuthChanged;
        const auth = window.AppAuth || window.firebaseAuth;
        if (onAuthChanged && auth){
          onAuthChanged(auth, (user)=>{
            if(!user){
              msgEl.innerHTML = "<strong>Sign-in required</strong><br/><span class='muted'>Please sign in on the home page to unlock quizzes.</span>";
              bodyEl.style.display="none";
            }else{
              resolve();
            }
          });
        } else {
          // Proceed even if auth layer isn't loaded (so we can still practice / debug)
          resolve();
        }
      });
    }

    // ---------------- Data loader ----------------
    async function fetchData(){
      log("Fetching", dataUrl);
      msgEl.textContent = "Preparing questions…";
      try{
        const res = await fetch(dataUrl, { cache:"no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        let data = await res.json();
        if(!Array.isArray(data)) throw new Error("Data is not an array");

        // De-duplicate, shuffle questions, shuffle options
        data = dedupeById(data);
        shuffleInPlace(data);
        data = data.map(withShuffledOptions);

        items = data;
        if(items.length === 0) throw new Error("No questions in file");
        msgEl.style.display = "none";
        bodyEl.style.display = "block";
        metaEl.textContent = `${level.toUpperCase()} — ${subject.replace(/_/g," ")}`;
        render();
        log(`Loaded ${items.length} items (deduped & shuffled)`);
      }catch(e){
        err("Error loading data", e);
        msgEl.innerHTML = "❌ Could not load questions.<br/><span class='muted'>Open console for details.</span>";
        bodyEl.style.display = "none";
      }
    }

    // ---------------- Render ----------------
    function render(){
      const q = items[idx];
      qnumEl.textContent = `Question ${idx+1} of ${items.length}`;
      stemEl.textContent = q.stem || q.question || "";
      optsEl.innerHTML = "";

      (q.options || []).forEach((opt, i)=>{
        const id = `opt_${idx}_${i}`;
        const label = document.createElement("label");
        label.className = "option";
        label.htmlFor = id;
        label.innerHTML = `<input type="radio" name="q_${idx}" id="${id}" value="${i}"/> ${opt}`;
        if (answers.get(q.id) === i) label.querySelector("input").checked = true;
        label.addEventListener("click", ()=>{
          answers.set(q.id, i);
        });
        optsEl.appendChild(label);
      });

      backBtn.disabled = idx === 0;
      nextBtn.disabled = idx === items.length - 1;
    }

    // ---------------- Nav ----------------
    backBtn.addEventListener("click", ()=>{ if(idx>0){ idx--; render(); }});
    nextBtn.addEventListener("click", ()=>{ if(idx<items.length-1){ idx++; render(); }});

    // ---------------- Results + persistence ----------------
    function computeScore(){
      let correct = 0;
      items.forEach(q=>{
        const chosen = answers.get(q.id);
        if (typeof chosen === "number" && chosen === q.answer_index) correct++;
      });
      const total = items.length;
      const score = Math.round((correct/total)*100);
      return {correct,total,score};
    }

    function updateLocalStatus({score,correct,total}){
      try{
        const key = "ican:status";
        const prev = JSON.parse(localStorage.getItem(key)||"{}");
        prev[level] = prev[level] || {};
        const sKey = subject;
        const now = new Date().toISOString();
        const old = prev[level][sKey] || { attempts:0 };
        prev[level][sKey] = {
          attempts: (old.attempts||0)+1,
          lastScore: score,
          lastCorrect: correct,
          lastTotal: total,
          lastAt: now
        };
        localStorage.setItem(key, JSON.stringify(prev));
      }catch(e){ warn("local status save failed", e); }
    }

    async function postToCloud({score,correct,total}){
      try{
        const user = (window.AppAuth || window.firebaseAuth)?.currentUser || null;
        const fs = window.firebase?.firestore ? window.firebase.firestore() : null;
        if(!user || !fs){ return; } // not signed in or Firestore unavailable

        const payload = {
          uid: user.uid,
          email: user.email || null,
          level, subject, score, correct, total,
          ts: new Date().toISOString()
        };

        // Primary collection (use what your leaderboard reads; trying common names)
        await fs.collection("scores").add(payload).catch(()=>{});
        await fs.collection("leaderboard").add(payload).catch(()=>{});
      }catch(e){
        warn("cloud post failed", e);
      }
    }

    submitBtn.addEventListener("click", async ()=>{
      const result = computeScore();
      updateLocalStatus(result);
      await postToCloud(result);

      const {score,correct,total} = result;
      cardEl.innerHTML = `
        <div class="muted" style="margin-bottom:8px">${level.toUpperCase()} — ${subject.replace(/_/g," ")}</div>
        <h2 style="margin:6px 0 12px">Your Score: ${score}%</h2>
        <p class="muted">Correct: ${correct} / ${total}</p>
        <div class="stack" style="margin-top:16px">
          <a href="./index.html" class="btn muted">← Home</a>
          <a href="./quiz.html?level=${encodeURIComponent(level)}&subject=${encodeURIComponent(subject)}" class="btn primary">Retry</a>
          <a href="./leaderboard.html" class="btn muted">Leaderboard</a>
          <a href="./status.html" class="btn muted">Status</a>
        </div>
      `;
      log("Submitted — score", score, "correct", correct, "of", total);
    });

    // ---------------- Boot ----------------
    (async function boot(){
      if(!level || !subject){
        msgEl.innerHTML = "❌ Missing <code>level</code> or <code>subject</code> in the URL.";
        return;
      }
      await waitAuthIfAvailable();
      if (bodyEl.style.display === "none" && msgEl.textContent.includes("Sign-in")) return;
      fetchData();
    })();
  })();
  </script>
</body>
</html>
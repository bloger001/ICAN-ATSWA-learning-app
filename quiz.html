<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Quiz</title>
  <link rel="stylesheet" href="./assets/app.css"/>
  <style>
    :root { --card:#141a19; --line:#26302d; --ink:#e7f4f0; --sub:#9db5ae; --chip:#23302c; }
    body{color:var(--ink)}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header.space-between{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .btn{display:inline-block;padding:.6rem .9rem;border-radius:.6rem;background:#24312d;color:var(--ink);text-decoration:none}
    .btn.primary{background:#2e7cf0;color:#fff;font-weight:600}
    .btn.muted{background:#1b2422;color:#cfe8df}
    .card{background:#121917;border:1px solid var(--line);border-radius:14px;padding:16px 18px;margin:14px 0}
    .muted{color:var(--sub)}
    .question{font-size:1.05rem;margin:8px 0 10px}
    .option{display:block;margin:8px 0;padding:8px 10px;border:1px solid #2a3632;border-radius:10px;cursor:pointer}
    .option input{margin-right:10px}
    .stack{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;border:1px solid #2a3632;background:#1a2321;color:#bddfd3;font-size:.78rem}
    .ok{color:#9cf3bf} .bad{color:#ffb3b3}
    .small{font-size:.9rem}
    .hr{height:1px;background:#26302d;margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="space-between">
      <h1>Quiz</h1>
      <a class="btn muted" href="./index.html">‚Üê Home</a>
    </header>

    <section class="card" id="quizCard">
      <div id="quizMsg" class="muted">Loading‚Ä¶</div>

      <div id="quizBody" style="display:none">
        <div id="meta" class="muted small" style="margin-bottom:6px"></div>
        <div id="qnum" class="muted small" style="margin-bottom:8px"></div>
        <div id="qstem" class="question"></div>
        <div id="opts"></div>

        <div class="stack" style="margin-top:14px">
          <button id="backBtn"   class="btn muted">‚Üê Back</button>
          <button id="nextBtn"   class="btn muted">Next ‚Üí</button>
          <button id="submitBtn" class="btn primary">Submit</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Core (same names as your site) -->
  <script src="./assets/firebase.js"></script>
  <script src="./assets/app.js"></script>

  <script>
  (function(){
    // ---------- URL params ----------
    const params  = new URLSearchParams(location.search);
    const level   = (params.get("level")   || "").toLowerCase();
    const subject = (params.get("subject") || "").toLowerCase();
    const dataUrl = `./data/${level}_${subject}.json`;

    // ---------- DOM ----------
    const msgEl   = document.getElementById("quizMsg");
    const cardEl  = document.getElementById("quizCard");
    const bodyEl  = document.getElementById("quizBody");
    const metaEl  = document.getElementById("meta");
    const qnumEl  = document.getElementById("qnum");
    const stemEl  = document.getElementById("qstem");
    const optsEl  = document.getElementById("opts");
    const backBtn = document.getElementById("backBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");

    // ---------- State ----------
    let items = [];
    let idx = 0;
    const picks = new Map(); // id -> chosen index

    // ---------- Utils ----------
    const shuffle = (a)=>{ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
    const dedupeById = (arr)=>{
      const seen = new Set(); const out=[];
      for(const q of arr){
        const id = q.id || q.qid || q.question_id || q.stem || q.question;
        if(!seen.has(id)){ seen.add(id); out.push(Object.assign({id},q)); }
      }
      return out;
    };
    const shuffleOptionsKeepingAnswer = (q)=>{
      const map = q.options.map((_,i)=>i); shuffle(map);
      const opts = map.map(i=>q.options[i]);
      const answer_index = map.indexOf(q.answer_index);
      return Object.assign({}, q, {options:opts, answer_index});
    };

    // ---------- Auth (optional gate) ----------
    function waitAuthGate(){
      return new Promise((resolve)=>{
        const auth = window.AppAuth || window.firebaseAuth;
        const onAuthChanged = window.AppOnAuthChanged;
        if (auth && onAuthChanged){
          onAuthChanged(auth, (user)=>{
            if(!user){
              msgEl.innerHTML = "<strong>Sign-in required</strong><br><span class='muted'>Please sign in on Home to unlock quizzes.</span>";
              bodyEl.style.display="none";
            } else {
              resolve();
            }
          });
        } else {
          // allow practice even if auth layer is absent
          resolve();
        }
      });
    }

    // ---------- Load ----------
    async function load(){
      if(!level || !subject){
        msgEl.innerHTML = "‚ùå Missing <code>level</code> or <code>subject</code>.";
        return;
      }
      await waitAuthGate();
      try{
        const res = await fetch(dataUrl, {cache:"no-store"});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        let data = await res.json();
        if(!Array.isArray(data)) throw new Error("Data format invalid");

        // Normalize+clean
        data = dedupeById(data);
        shuffle(data);
        data = data.map(shuffleOptionsKeepingAnswer);

        items = data;
        metaEl.textContent = `${level.toUpperCase()} ‚Äî ${subject.replace(/_/g," ")}`;
        msgEl.style.display = "none";
        bodyEl.style.display = "block";
        render();
      }catch(e){
        console.error("[QUIZ] load error", e);
        msgEl.innerHTML = "‚ùå Could not load questions.";
      }
    }

    // ---------- Render ----------
    function render(){
      const q = items[idx];
      qnumEl.textContent = `Question ${idx+1} of ${items.length}`;
      stemEl.textContent = q.stem || q.question || "";
      optsEl.innerHTML = "";
      (q.options||[]).forEach((opt,i)=>{
        const id = `opt_${idx}_${i}`;
        const lab = document.createElement("label");
        lab.className="option";
        lab.htmlFor=id;
        lab.innerHTML = `<input type="radio" name="q_${idx}" id="${id}" value="${i}"/> ${opt}`;
        if (picks.get(q.id) === i) lab.querySelector("input").checked = true;
        lab.addEventListener("click", ()=>{ picks.set(q.id, i); });
        optsEl.appendChild(lab);
      });
      backBtn.disabled = idx===0;
      nextBtn.disabled = idx===items.length-1;
    }

    backBtn.onclick = ()=>{ if(idx>0){ idx--; render(); } };
    nextBtn.onclick = ()=>{ if(idx<items.length-1){ idx++; render(); } };

    // ---------- Score + persistence ----------
    function compute(){
      let correct=0;
      const detail = items.map(q=>{
        const chosen = picks.get(q.id);
        const ok = (typeof chosen==="number") && (chosen===q.answer_index);
        if (ok) correct++;
        return {
          id:q.id, stem:q.stem||q.question||"",
          options:q.options.slice(),
          correctIndex:q.answer_index,
          chosenIndex: typeof chosen==="number" ? chosen : null
        };
      });
      const total = items.length;
      const score = Math.round((correct/total)*100);
      return {score, correct, total, detail};
    }

    function saveLocal({score,correct,total,detail}){
      // last attempt (used for Review)
      localStorage.setItem("ican:lastAttempt", JSON.stringify({
        level, subject, score, correct, total, detail, ts: new Date().toISOString()
      }));
      // status summary (used by Status page)
      const KEY="ican:status";
      const prev = JSON.parse(localStorage.getItem(KEY)||"{}");
      prev[level] = prev[level] || {};
      const old = prev[level][subject] || { attempts:0 };
      prev[level][subject] = {
        attempts:(old.attempts||0)+1,
        bestScore: Math.max(old.bestScore||0, score),
        lastScore: score,
        lastCorrect: correct,
        lastTotal: total,
        lastAt: new Date().toISOString()
      };
      localStorage.setItem(KEY, JSON.stringify(prev));
      // notify other tabs/pages
      try{ window.dispatchEvent(new Event("ican:status-updated")); }catch{}
    }

    async function saveCloud({score,correct,total}){
      try{
        const auth = window.AppAuth || window.firebaseAuth;
        const user = auth?.currentUser || null;
        const fs = window.firebase?.firestore ? window.firebase.firestore() : null;
        if (!user || !fs) return;
        const payload = {
          uid:user.uid, email:user.email||null,
          level, subject, score, correct, total,
          ts: new Date().toISOString()
        };
        // Write to a generic scores collection (common name used by leaderboard)
        await fs.collection("scores").add(payload);
      }catch(e){ console.warn("[QUIZ] cloud save skipped:", e.message); }
    }

    // ---------- Submit ----------
    submitBtn.onclick = async ()=>{
      const summary = compute();
      saveLocal(summary);
      await saveCloud(summary);

      // Build on-page Review (no separate page required)
      const wrong = summary.detail.filter(d => d.chosenIndex !== null && d.chosenIndex !== d.correctIndex);
      const reviewHtml = wrong.length === 0
        ? `<div class="ok">Perfect! No mistakes üéâ</div>`
        : wrong.map((d,i)=>{
            const chosen = d.chosenIndex!=null ? d.options[d.chosenIndex] : "(no answer)";
            const right  = d.options[d.correctIndex];
            return `
              <div style="margin:10px 0">
                <div><span class="badge">#${i+1}</span> ${d.stem}</div>
                <div class="small bad">Your answer: ${chosen}</div>
                <div class="small ok">Correct: ${right}</div>
              </div>`;
          }).join("");

      cardEl.innerHTML = `
        <div class="muted small">${level.toUpperCase()} ‚Äî ${subject.replace(/_/g," ")}</div>
        <h2 style="margin:6px 0 8px">Your Score: ${summary.score}%</h2>
        <div class="muted">Correct: ${summary.correct} / ${summary.total}</div>

        <div class="hr"></div>
        <h3 style="margin:6px 0 6px">Review mistakes</h3>
        ${reviewHtml}

        <div class="hr"></div>
        <div class="stack" style="margin-top:6px">
          <a href="./index.html" class="btn muted">‚Üê Home</a>
          <a href="./status.html" class="btn muted">Status</a>
          <a href="./leaderboard.html" class="btn muted">Leaderboard</a>
          <a href="./quiz.html?level=${encodeURIComponent(level)}&subject=${encodeURIComponent(subject)}" class="btn primary">Retry</a>
        </div>
      `;
    };

    // ---------- Boot ----------
    load();
  })();
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Quiz ‚Ä¢ ICAN ATSWA</title>
  <link rel="stylesheet" href="./assets/app.css"/>

  <!-- Firebase COMPAT SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>

  <!-- Project initializer -->
  <script src="./assets/firebase.js?v=106"></script>

  <!-- Hooks for saving results + mistakes -->
  <script src="./assets/quiz-hooks.js?v=106"></script>

  <style>
    .wrap{max-width:800px;margin:0 auto;padding:20px}
    .question{margin:20px 0;padding:16px;border:1px solid #26302d;border-radius:10px;background:#141a19}
    .options button{display:block;width:100%;margin:6px 0;padding:10px;border-radius:8px;border:none;text-align:left}
    .options button.correct{background:#1a3d2c;color:#fff}
    .options button.wrong{background:#3d1a1a;color:#fff}
    #resultBox{margin-top:20px;padding:14px;border:1px solid #26302d;border-radius:10px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="quizTitle">Quiz</h1>
    <div id="quizBox"></div>
    <div id="resultBox"></div>
  </div>

<script>
(function(){
  const db = firebase.firestore();
  const user = () => firebase.auth().currentUser;

  // --- Setup ---
  const params = new URLSearchParams(location.search);
  const level   = params.get("level")   || "atswa1";
  const subject = params.get("subject") || "basic_accounting";

  document.getElementById("quizTitle").textContent =
    `Quiz: ${subject.replace(/_/g," ")}`;

  // --- Dummy question bank (replace with your loader) ---
  const questions = [
    { id:"q1", text:"What is double entry?", options:["One record","Two records","Three records","None"], answer:"Two records" },
    { id:"q2", text:"Which is an asset?", options:["Cash","Loan","Expense","Liability"], answer:"Cash" }
  ];

  let current = 0;
  let score   = 0;
  let total   = questions.length;

  const quizBox   = document.getElementById("quizBox");
  const resultBox = document.getElementById("resultBox");

  // --- Render a question ---
  function renderQuestion(q){
    quizBox.innerHTML = `
      <div class="question">
        <p><b>Q${current+1}:</b> ${q.text}</p>
        <div class="options"></div>
      </div>
    `;
    const optBox = quizBox.querySelector(".options");
    q.options.forEach(opt=>{
      const btn = document.createElement("button");
      btn.textContent = opt;
      btn.onclick = () => handleAnswer(q,opt,btn);
      optBox.appendChild(btn);
    });
  }

  // --- Handle answer ---
  async function handleAnswer(q, chosen, btn){
    const buttons = quizBox.querySelectorAll("button");
    buttons.forEach(b=>b.disabled=true);

    if (chosen === q.answer){
      score++;
      btn.classList.add("correct");
    } else {
      btn.classList.add("wrong");
      // üîπ Save mistake
      try {
        await window.quizStorage.saveMistake({
          qid: q.id, subject, chosen, correct:q.answer
        });
      } catch(e){ console.warn("mistake save failed",e); }
    }

    // show correct
    buttons.forEach(b=>{
      if (b.textContent===q.answer) b.classList.add("correct");
    });

    setTimeout(nextQuestion,1000);
  }

  // --- Next question or finish ---
  async function nextQuestion(){
    current++;
    if (current < total){
      renderQuestion(questions[current]);
    } else {
      quizBox.innerHTML = "";
      resultBox.style.display="block";
      resultBox.innerHTML = `<h2>Finished!</h2>
        <p>Score: ${score}/${total}</p>`;

      // üîπ Save final result
      try {
        await window.quizStorage.saveQuizResult({ level, subject, score, total });
        resultBox.innerHTML += `<p>Result saved ‚úÖ</p>`;
      } catch(e){
        resultBox.innerHTML += `<p style="color:red">Result save failed ‚ùå</p>`;
        console.error("saveQuizResult failed",e);
      }
    }
  }

  // --- Start quiz ---
  renderQuestion(questions[current]);
})();
</script>
</body>
</html>
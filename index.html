<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ICAN ATSWA Prep</title>
  <link rel="stylesheet" href="./assets/app.css"/>

  <!-- Firebase COMPAT SDKs (ORDER MATTERS) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- Optional: analytics compat (safe to include; will only run if configured) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>

  <!-- Your Firebase init (config + initializeApp) -->
  <script src="./assets/firebase.js"></script>

  <!-- Page-scoped styles (safe) -->
  <style>
    :root { --card:#141a19; --line:#26302d; --ink:#e7f4f0; --sub:#9db5ae; --chip:#23302c; }
    body{color:var(--ink)}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header.space-between{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .pill{padding:.45rem .8rem;border-radius:999px;background:var(--chip);color:#cfe8df;font-size:.9rem}
    .btn{display:inline-block;padding:.6rem .9rem;border-radius:.6rem;background:#24312d;color:var(--ink);text-decoration:none}
    .btn.primary{background:#2e7cf0;color:#fff;font-weight:600}
    .btn.outline{background:transparent;border:1px solid #3a4a45}
    .btn[aria-disabled="true"]{opacity:.6;pointer-events:none}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px 18px;margin:14px 0}
    h1{margin:0 0 8px 0;font-size:2.2rem}
    h2.section{font-size:1.05rem;letter-spacing:.03em;color:#a9c3bb;margin:26px 6px 8px}
    .tile-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (min-width:740px){.tile-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .tile{
      position:relative; display:block; text-decoration:none; color:var(--ink);
      background:#0f1715; border:1px solid #27322f; border-radius:14px; padding:14px 16px; min-height:64px;
    }
    .tile .muted{color:var(--sub);font-size:.82rem;margin-bottom:4px}
    .tile .title{font-size:1.02rem}
    .tile.disabled{opacity:.55; pointer-events:none}
    .tile .locked{
      position:absolute; right:10px; top:10px; font-size:.82rem; color:#b6c9c3; background:#1c2724;
      border:1px solid #2b3834; padding:.15rem .45rem; border-radius:999px; display:none;
    }
    .stack{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="space-between">
      <h1>ICAN ATSWA Prep</h1>
      <div class="stack">
        <span id="userStatus" class="pill">Not signed in</span>
        <!-- Starts disabled; enabled after Firebase auth is ready -->
        <a class="btn primary" id="btnGoogle" href="#" aria-disabled="true">Continue with Google</a>
        <a id="signOutBtn" class="btn outline" href="#" style="display:none">Sign out</a>
      </div>
    </header>

    <section class="card">
      <p class="muted">Built by fellow accounting student <strong>Silva Brutus (NSUK)</strong>.
        Contact: <a href="mailto:offixcialbloger@gmail.com">offixcialbloger@gmail.com</a></p>
      <h2>Welcome</h2>
      <p>Please sign in to unlock quizzes, leaderboard and your personalized status.</p>
    </section>

    <h2 class="section">Study</h2>
    <div class="tile-grid">
      <a class="tile" href="./resources.html">
        <div class="muted">Study</div><div class="title">Resources</div>
      </a>
    </div>

    <h2 class="section">Track</h2>
    <div class="tile-grid">
      <a class="tile" href="./status.html">
        <div class="muted">Progress</div><div class="title">Status</div>
      </a>
      <a class="tile" href="./leaderboard.html">
        <div class="muted">Community</div><div class="title">Leaderboard</div>
      </a>
    </div>

    <h2 class="section">ATSWA 1</h2>
    <div class="tile-grid">
      <a class="tile requires-auth" href="./quiz.html?level=atswa1&subject=basic_accounting">
        <div class="muted">ATSWA 1</div><div class="title">Basic Accounting</div><div class="locked">ðŸ”’ Sign in</div>
      </a>
      <a class="tile requires-auth" href="./quiz.html?level=atswa1&subject=business_law">
        <div class="muted">ATSWA 1</div><div class="title">Business Law</div><div class="locked">ðŸ”’ Sign in</div>
      </a>
      <a class="tile requires-auth" href="./quiz.html?level=atswa1&subject=economics">
        <div class="muted">ATSWA 1</div><div class="title">Economics</div><div class="locked">ðŸ”’ Sign in</div>
      </a>
      <a class="tile requires-auth" href="./quiz.html?level=atswa1&subject=comm_skills">
        <div class="muted">ATSWA 1</div><div class="title">Communication Skills</div><div class="locked">ðŸ”’ Sign in</div>
      </a>
    </div>

    <h2 class="section">Admin</h2>
    <div class="tile-grid">
      <a id="adminTile" class="tile" href="./admin.html">
        <div class="muted">Admin</div><div class="title">Dashboard</div><div class="locked">ðŸ”’ Admin only</div>
      </a>
    </div>
  </div>

  <!-- Your app scripts (no duplicate Firebase init here) -->
  <script src="./assets/app.js"></script>

  <!-- Home bootstrap (waits for auth, then enables UI) -->
  <script>
  (function(){
    const ADMIN_EMAIL = "offixcialbloger@gmail.com";

    const statusEl   = document.getElementById("userStatus");
    const googleBtn  = document.getElementById("btnGoogle");
    const signOutBtn = document.getElementById("signOutBtn");
    const authTiles  = Array.from(document.querySelectorAll(".requires-auth"));
    const adminTile  = document.getElementById("adminTile");

    function lockAuthTiles(lock){
      authTiles.forEach(t=>{
        const b=t.querySelector(".locked");
        if(lock){ t.classList.add("disabled"); if(b) b.style.display="inline-block"; }
        else     { t.classList.remove("disabled"); if(b) b.style.display="none"; }
      });
    }
    function lockAdmin(lock){
      const b=adminTile.querySelector(".locked");
      if(lock){ adminTile.classList.add("disabled"); adminTile.href="#"; if(b) b.style.display="inline-block"; }
      else    { adminTile.classList.remove("disabled"); adminTile.href="./admin.html"; if(b) b.style.display="none"; }
    }
    function enableGoogle(){ googleBtn.setAttribute("aria-disabled","false"); }
    function disableGoogle(){ googleBtn.setAttribute("aria-disabled","true"); }

    lockAuthTiles(true); lockAdmin(true); disableGoogle();

    // Bind sign-in after Firebase is present
    googleBtn.addEventListener("click", function(e){
      e.preventDefault();
      if (googleBtn.getAttribute("aria-disabled")==="true") return;
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).catch(console.error);
    });

    signOutBtn.addEventListener("click", function(e){
      e.preventDefault();
      firebase.auth().signOut().catch(console.error);
    });

    // Auth observer controls the whole page state
    firebase.auth().onAuthStateChanged(function(user){
      if (user) {
        statusEl.textContent = "Signed in as " + (user.email || "");
        googleBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";
        enableGoogle();
        lockAuthTiles(false);
        lockAdmin(!(user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()));
      } else {
        statusEl.textContent = "Not signed in";
        googleBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        enableGoogle();            // allow user to click and start sign-in
        lockAuthTiles(true);
        lockAdmin(true);
      }
    });
  })();
  </script>

  <!-- Hub bridge: responds to Admin diagnostics page via BroadcastChannel -->
  <script>
  (function(){
    const ch = new BroadcastChannel('aihub');
    const modules = [];

    if (window.firebase) modules.push('firebase');
    // If you expose modules later, keep these names so Admin can see them:
    if (window.quizEngine) modules.push('quizEngine');
    if (window.leaderboard) modules.push('leaderboard');
    if (window.statusPage) modules.push('status');

    ch.addEventListener('message', (ev)=>{
      const msg = ev.data||{};
      if (msg.type==='ping'){
        ch.postMessage({type:'pong', from:'index.html', pingId: msg.pingId});
      }
      if (msg.type==='modules.request'){
        ch.postMessage({type:'modules.info', modules});
      }
      if (msg.type==='bank.push' && typeof msg.len==='number'){
        // Optional: reload bank from localStorage.quiz.bankJSON here
        console.log('[index bridge] bank pushed, len=', msg.len);
      }
    });
  })();
  </script>
</body>
</html>